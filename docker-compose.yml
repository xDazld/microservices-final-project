services:
  # Main DNS Shield Application
  dns-shield:
    build:
      context: .
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: dns-shield-app
    ports:
      - "8080:8080"
    environment:
      # Database Configuration
      QUARKUS_DATASOURCE_DB_KIND: mariadb
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:mariadb://mariadb:3306/dns_shield
      QUARKUS_DATASOURCE_USERNAME: ${DB_USER:-dns_user}
      QUARKUS_DATASOURCE_PASSWORD: ${DB_PASSWORD:-dns_password}
      QUARKUS_DATASOURCE_REACTIVE_URL: mysql://mariadb:3306/dns_shield

      # MongoDB Configuration
      QUARKUS_MONGODB_CONNECTION_STRING: mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-admin}@mongodb:27017/${MONGO_DB:-dns_shield}?authSource=admin
      QUARKUS_MONGODB_DATABASE: ${MONGO_DB:-dns_shield}

      # RabbitMQ Configuration
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-admin}
      RABBITMQ_VHOST: /

      # Ollama Configuration
      QUARKUS_LANGCHAIN4J_OLLAMA_BASE_URL: http://ollama:11434
      QUARKUS_LANGCHAIN4J_TIMEOUT: 120s

      # Metrics
      QUARKUS_MICROMETER_EXPORT_PROMETHEUS_PATH: /metrics

      # JWT/Security
      MP_JWT_VERIFY_ISSUER: https://dns-shield.local
      SMALLRYE_JWT_SIGN_KEY_LOCATION: file:///app/config/keys/privateKey.pem
      MP_JWT_VERIFY_PUBLICKEY_LOCATION: file:///app/config/keys/publicKey.pem

      # CORS
      QUARKUS_HTTP_CORS: "true"
      QUARKUS_HTTP_CORS_ORIGINS: "/.*/"
      QUARKUS_HTTP_CORS_METHODS: "GET,POST,PUT,DELETE,PATCH"
      QUARKUS_HTTP_CORS_HEADERS: "accept,authorization,content-type,x-requested-with"

      # RFC Compliance
      DNS_RFC5358_RECURSION_ENABLED: "true"
      DNS_RFC5358_DEFAULT_DENY: "false"
      DNS_RFC5358_ALLOWED_NETWORKS: "127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,::1/128,fc00::/7"
      DNS_NEGATIVE_CACHE_MIN_DURATION: "1"
      DNS_NEGATIVE_CACHE_MAX_DURATION: "300"
      DNS_STALE_MAX_AGE: "86400"

      # Statistics
      DNS_STATISTICS_ENABLED: "true"
      DNS_STATISTICS_TRACK_PAYLOAD_SIZE: "true"

      # Debug
      JAVA_DEBUG: "false"
      JAVA_OPTS_APPEND: "-Dquarkus.log.level=INFO"

    volumes:
      - dns-shield-data:/opt/app
    depends_on:
      mariadb:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ollama:
        condition: service_started
    networks:
      - dns-shield-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/v1/admin/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MariaDB Database Service
  mariadb:
    image: docker.io/library/mariadb:10.11
    container_name: dns-shield-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-dns_shield}
      MYSQL_USER: ${DB_USER:-dns_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-dns_password}
      MARIADB_AUTO_UPGRADE: "1"
    volumes:
      - mariadb-data:/var/lib/mysql
      - ./src/main/resources/db-init:/docker-entrypoint-initdb.d:ro
    networks:
      - dns-shield-network
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--su=mysql", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # RabbitMQ Message Broker
  rabbitmq:
    image: docker.io/library/rabbitmq:3.12-management
    container_name: dns-shield-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-admin}
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - dns-shield-network
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "ping" ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Ollama AI Service
  ollama:
    image: docker.io/ollama/ollama:latest
    container_name: dns-shield-ollama
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
      OLLAMA_MODELS_PATH: /root/.ollama/models
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - dns-shield-network
    entrypoint: >
      /bin/sh -c
      "ollama serve &
      sleep 10;
      ollama pull qwen3:0.6b;
      wait"

  # MongoDB Storage Service
  mongodb:
    image: docker.io/library/mongo:7.0
    container_name: dns-shield-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-admin}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-dns_shield}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    networks:
      - dns-shield-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Grafana LGTM Stack (Loki, Grafana, Tempo, Mimir)
  otel-lgtm:
    image: docker.io/grafana/otel-lgtm:0.11.0
    container_name: dns-shield-otel-lgtm
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
    volumes:
      - otel-lgtm-data:/data
    networks:
      - dns-shield-network
    depends_on:
      - dns-shield

volumes:
  mariadb-data:
    driver: local
  rabbitmq-data:
    driver: local
  ollama-data:
    driver: local
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local
  otel-lgtm-data:
    driver: local
  dns-shield-data:
    driver: local

networks:
  dns-shield-network:
    driver: bridge

