version: '3.9'

services:
  # Main DNS Shield Application
  dns-shield:
    build:
      context: .
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: dns-shield-app
    ports:
      - "8080:8080"
      - "5005:5005"  # Debug port
    environment:
      # Database Configuration
      QUARKUS_DATASOURCE_DB_KIND: mariadb
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:mariadb://mariadb:3306/dns_shield
      QUARKUS_DATASOURCE_USERNAME: ${DB_USER:-dns_user}
      QUARKUS_DATASOURCE_PASSWORD: ${DB_PASSWORD:-dns_password}
      QUARKUS_DATASOURCE_REACTIVE_URL: mysql://mariadb:3306/dns_shield

      # Kafka Configuration
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MP_MESSAGING_INCOMING_DNS_EVENTS_BOOTSTRAP_SERVERS: kafka:9092
      MP_MESSAGING_OUTGOING_DNS_STATS_BOOTSTRAP_SERVERS: kafka:9092

      # Ollama Configuration
      QUARKUS_LANGCHAIN4J_OLLAMA_BASE_URL: http://ollama:11434
      QUARKUS_LANGCHAIN4J_TIMEOUT: 120s

      # Metrics
      QUARKUS_MICROMETER_EXPORT_PROMETHEUS_PATH: /metrics

      # JWT/Security
      MP_JWT_VERIFY_ISSUER: https://dns-shield.local
      SMALLRYE_JWT_SIGN_KEY_LOCATION: file:///app/config/keys/privateKey.pem
      MP_JWT_VERIFY_PUBLICKEY_LOCATION: file:///app/config/keys/publicKey.pem

      # CORS
      QUARKUS_HTTP_CORS: "true"
      QUARKUS_HTTP_CORS_ORIGINS: "/.*/"
      QUARKUS_HTTP_CORS_METHODS: "GET,POST,PUT,DELETE,PATCH"
      QUARKUS_HTTP_CORS_HEADERS: "accept,authorization,content-type,x-requested-with"

      # RFC Compliance
      DNS_RFC5358_RECURSION_ENABLED: "true"
      DNS_RFC5358_DEFAULT_DENY: "false"
      DNS_RFC5358_ALLOWED_NETWORKS: "127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,::1/128,fc00::/7"
      DNS_NEGATIVE_CACHE_MIN_DURATION: "1"
      DNS_NEGATIVE_CACHE_MAX_DURATION: "300"
      DNS_STALE_MAX_AGE: "86400"

      # Statistics
      DNS_STATISTICS_ENABLED: "true"
      DNS_STATISTICS_TRACK_PAYLOAD_SIZE: "true"

      # Debug
      JAVA_DEBUG: "false"
      JAVA_OPTS_APPEND: "-Dquarkus.log.level=INFO"

    volumes:
      - ./src/main/resources/keys:/app/config/keys:ro
      - dns-shield-data:/opt/app
    depends_on:
      mariadb:
        condition: service_healthy
      kafka:
        condition: service_healthy
      ollama:
        condition: service_started
    networks:
      - dns-shield-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/q/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MariaDB Database Service
  mariadb:
    image: docker.io/library/mariadb:latest
    container_name: dns-shield-db
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-dns_shield}
      MYSQL_USER: ${DB_USER:-dns_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-dns_password}
      MARIADB_AUTO_UPGRADE: "1"
    volumes:
      - mariadb-data:/var/lib/mysql
      - ./src/main/resources/db-init:/docker-entrypoint-initdb.d:ro
    networks:
      - dns-shield-network
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--su=mysql", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Kafka/Redpanda Message Broker
  kafka:
    image: docker.io/redpandadata/redpanda:latest
    container_name: dns-shield-kafka
    ports:
      - "9092:9092"
      - "9644:9644"  # Admin API
      - "8082:8082"  # Schema Registry
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://kafka:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://kafka:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr kafka:33145
      - --advertise-rpc-addr kafka:33145
      - --mode dev-container
      - --smp 1
      - --default-log-level=info
    volumes:
      - kafka-data:/var/lib/redpanda/data
    networks:
      - dns-shield-network
    healthcheck:
      test: [ "CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true' || exit 1" ]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 30s

  # Ollama AI Service
  ollama:
    image: docker.io/ollama/ollama:latest
    container_name: dns-shield-ollama
    ports:
      - "11434:11434"
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
      OLLAMA_MODELS_PATH: /root/.ollama/models
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - dns-shield-network

  # Grafana LGTM Stack (Loki, Grafana, Tempo, Mimir)
  otel-lgtm:
    image: docker.io/grafana/otel-lgtm:0.11.0
    container_name: dns-shield-otel-lgtm
    ports:
      - "3000:3000"   # Grafana
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "9090:9090"   # Mimir (Prometheus compatible)
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
    volumes:
      - otel-lgtm-data:/data
    networks:
      - dns-shield-network
    depends_on:
      - dns-shield

volumes:
  mariadb-data:
    driver: local
  kafka-data:
    driver: local
  ollama-data:
    driver: local
  otel-lgtm-data:
    driver: local
  dns-shield-data:
    driver: local

networks:
  dns-shield-network:
    driver: bridge

